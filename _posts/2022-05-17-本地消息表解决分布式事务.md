---
layout: post
title:  "本地消息表解决分布式事务"
date:   2022-05-17 10:00:00 +0800
author: Vito
categories: ["分布式事务","解决方案"]
---
## 概述
分布式事务一直以来就是micro service架构下的一个难点，由于db不在同一个数据库中，导致事务的一致性，无法用传统的关系型数据库来保证，目前主流的做法，都是在可以容忍短暂数据不一致的情况下，保证数据在有限的时间内达到最终一致。

那么如何来实现这个目前，下文将对主流的几种解决方法做进行讨论。

## 本地消息表
在本地数据库中，加入消息表。
1. 更新本地db（biz logic）的同时插入一条消息记录到消息表.
2. 发消息，驱动下游系统更新数据，
* 如果发消息失败，消息重试，如果始终失败，有扫描消息表重试机制兜底。
* 如果消息发送成功，更新db消息表记录为已发送成功，此时如果更新消息记录失败，应有幂等机制允许重新扫描发送。
3. （Optional）更新本地db的biz logic中，可以加入异步call下游以提高时效性。


## 注意
RabbitMq事务消息只能保证在客户端没有报错的情况下，消息一定能发送到broker，但是并不能保证，在客户端报错的情况下，消息是没有被broker收到的，也就是说，无法保证消息的事务与db的事务是能绑定一致的，所以仅靠RabbitMq，是无法保证事务一致性的。
![RabbitMQ Transactional Msg](https://raw.githubusercontent.com/zyysxz/zyysxz.github.io/main/_posts/pictures/RabbitMQ_transaction_msg.png)